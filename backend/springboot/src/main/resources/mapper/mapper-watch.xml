<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="lx.iseau.feature.watch.WatchDAO">

    <!-- ðŸ’¡ [ìˆ˜ì •]: keyColumn="watch_number" ëª…ì‹œì ìœ¼ë¡œ ì¶”ê°€ -->
    <insert id="insertWatchEvent" useGeneratedKeys="true" keyProperty="watchNumber" keyColumn="watch_number">
        INSERT INTO tb_watch (
            heart_rate,
            occurred_at,
            user_number
        ) VALUES (
                     #{heartRate},
                     #{occurredAt},
                     #{userNumber}
                 )
    </insert>

    <!-- ì›Œì¹˜ ë‹¨ê±´ ì¡°íšŒ (selectWatchByNumber)ëŠ” ì´ë¯¸ ASë¥¼ ì‚¬ìš©í•˜ì—¬ ì»¬ëŸ¼ ë§¤í•‘ì´ ì˜¬ë°”ë¥´ê²Œ ë˜ì–´ ìžˆìŠµë‹ˆë‹¤. -->
    <select id="selectWatchByNumber" parameterType="int" resultType="map">
        SELECT
            w.watch_number AS watchNumber,
            w.user_number  AS userNumber,
            w.heart_rate   AS heartRate,
            w.occurred_at  AS occurredAt
        FROM tb_watch w
        WHERE w.watch_number = #{watchNumber}
    </select>

    <!-- ìœ ì € â†’ ë¹„ì¹˜ â†’ ê´€ì œ â†’ ë§¤ë‹ˆì €(1:1) -->
    <select id="findManagerByUser" parameterType="int" resultType="int">
        SELECT m.manager_number
        FROM tb_user u
                 JOIN tb_beach b ON b.beach_number = u.beach_number
                 JOIN tb_manager m ON m.control_tower_number = b.control_tower_number
        WHERE u.user_number = #{userNumber}
            LIMIT 1
    </select>

    <!-- tb_task ìƒì„± (ì´ë¯¸ ì¡´ìž¬í•˜ë©´ ë§Œë“¤ì§€ ì•ŠìŒ) -->
    <insert id="insertTaskIfAbsent" parameterType="map">
        INSERT INTO tb_task (manager_number, watch_number)
        SELECT #{managerNumber}, #{watchNumber}
            WHERE NOT EXISTS (
          SELECT 1 FROM tb_task t WHERE t.watch_number = #{watchNumber}
            )
    </insert>

</mapper>