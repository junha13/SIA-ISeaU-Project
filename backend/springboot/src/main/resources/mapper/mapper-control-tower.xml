<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
  관제/매니저 이름 기반 조회 매퍼
-->
<mapper namespace="lx.iseau.feature.controltower.ControlTowerDAO">

    <!-- 관제타워 이름으로 매니저 단건 -->
    <select id="selectManagerByControlTowerName"
            parameterType="string"
            resultType="ManagerInfoDTO">
        SELECT
            m.manager_number                 AS managerNumber,
            u.user_name                      AS userName,
            u.mobile                         AS mobile,
            u.email                          AS email
        FROM tb_control_tower ct
        JOIN tb_manager m
          ON m.control_tower_number = ct.control_tower_number
        JOIN tb_user u
          ON u.user_number = m.manager_number
        WHERE ct.control_tower_name = #{controlTowerName}
        LIMIT 1
    </select>

    <!-- 매니저(사용자) 이름으로 매니저 단건 -->
    <select id="selectManagerByUserName"
            parameterType="string"
            resultType="ManagerInfoDTO">
        SELECT
            m.manager_number   AS managerNumber,
            u.user_name        AS userName,
            u.mobile           AS mobile,
            u.email            AS email
        FROM tb_manager m
        JOIN tb_user u
          ON u.user_number = m.manager_number
        WHERE u.user_name = #{userName}
        LIMIT 1
    </select>

    <!-- 매니저번호로 처리 리스트 (task + watch + user(location)) -->
    <select id="selectTasksByManager"
            parameterType="int"
            resultType="TaskItemDTO">
        SELECT
            t.task_number      AS taskNumber,
            t.task_accepted    AS taskAccepted,
            t.task_processed   AS taskProcessed,
            w.occurred_at      AS occurredAt,
            w.heart_rate       AS heartRate,
            w.spo2             AS spo2,
            ST_Y(u.location::geometry) AS userLat,
            ST_X(u.location::geometry) AS userLon
        FROM tb_task t
        JOIN tb_watch w ON w.watch_number = t.watch_number
        JOIN tb_user  u ON u.user_number = w.user_number
        WHERE t.manager_number = #{managerNumber}
        ORDER BY w.occurred_at DESC
    </select>

</mapper>
