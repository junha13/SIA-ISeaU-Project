<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="lx.iseau.feature.auth.AuthDAO">

    <!-- 회원가입 -->
    <insert id="register" parameterType="lx.iseau.feature.auth.RegisterDTO">
        INSERT INTO tb_user (user_name, email, mobile, birth_date, id, password, role_number)
        VALUES (
            #{registerDTO.userName},
            #{registerDTO.email},
            #{registerDTO.mobile},
            to_date(#{registerDTO.birthDate}, 'YYYY-MM-DD'),
            #{registerDTO.id},
            #{registerDTO.password},
            2
        )
    </insert>

    <!-- 아이디 중복확인 -->
    <select id="checkId" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM tb_user
        WHERE id = #{id}
    </select>

    <!-- 로그인 -->
    <select id="login" parameterType="lx.iseau.feature.auth.LoginDTO" resultType="Map">
        SELECT user_number, id, user_name
        FROM tb_user
        WHERE id = #{loginDTO.id}
          AND password = #{loginDTO.password}
    </select>

    <!-- 회원탈퇴 -->
    <delete id="withdraw" parameterType="int">
        DELETE FROM tb_user
        WHERE user_number = #{userNumber}
    </delete>

    <!-- 아이디 찾기 -->
    <select id="findId" parameterType="lx.iseau.feature.auth.FindIdDTO" resultType="string">
        SELECT id
        FROM tb_user
        WHERE user_name = #{findIdDTO.userName}
          AND mobile = #{findIdDTO.mobile}
    </select>

    <!-- 비밀번호 찾기: 아이디+전화번호로 userNumber 조회 -->
    <select id="findUserNumber" parameterType="lx.iseau.feature.auth.FindUserNumberDTO" resultType="int">
        SELECT user_number
        FROM tb_user
        WHERE id = #{findUserNumberDTO.id}
          AND mobile = #{findUserNumberDTO.mobile}
    </select>
    
    <!-- 비밀번호 찾기: 아이디+전화번호로 userNumber 조회 -->
    <select id="findUserNumberByUserId" parameterType="String" resultType="int">
        SELECT user_number
        FROM tb_user
        WHERE id = #{id}
    </select>

    <!-- 비밀번호 재설정 -->
    <update id="resetPassword" parameterType="lx.iseau.feature.auth.ResetPasswordDTO">
        UPDATE tb_user
        SET password = #{resetPasswordDTO.newPassword}
        WHERE user_number = #{resetPasswordDTO.userNumber}
    </update>

</mapper>