<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="lx.iseau.feature.forecast.ForecastDAO">

    <!-- ========== 해수욕장 위치 가져오기 ========== -->
    <select id="selectBeachLocation" resultType="RequestLocationDTO">
        SELECT beach_number, ST_Y(location::geometry) AS lat, ST_X(location::geometry) AS lon 
        FROM tb_beach
    </select>
    
    <!-- ========== 기상예보 업데이트 ========== -->
    <insert id="upsertWeatherDB" parameterType="java.util.List">
    	insert into tb_weather_info (temperature, humidity, rain, wind_gusts, wind_speed, wind_direction, forecast_time, observed_location)
    	values 
	    <foreach collection="list" item="it" separator=",">
	      (
	        #{it.temperature},
	        #{it.humidity},
	        #{it.rain},
	        #{it.windGusts},
	        #{it.windSpeed},
	        #{it.windDirection},
	        #{it.forecastTime},
	        ST_SetSRID(ST_MakePoint(#{it.lon}, #{it.lat}), 4326)
	      )
	    </foreach>
    	ON CONFLICT ((ST_Y(observed_location::geometry)), (ST_X(observed_location::geometry)), forecast_time)
	    DO UPDATE SET
	    <!-- 방금 insert하려는데 값이 이미 있으면 넣으려던 값으로 update -->
	      temperature       = EXCLUDED.temperature,
	      humidity          = EXCLUDED.humidity,
	      rain              = EXCLUDED.rain,
	      wind_gusts         = EXCLUDED.wind_gusts,
	      wind_speed         = EXCLUDED.wind_speed,
	      wind_direction     = EXCLUDED.wind_direction,
	      observed_location = EXCLUDED.observed_location
    </insert>
    
    
    <!-- ========== 기상예보 업데이트 ========== -->
    <insert id="upsertBeachWeatherDB" parameterType="java.util.List">
    	insert into tb_beach_weather_info (wave_height, sea_surface_temperature, forecast_time, observed_location)
    	values 
	    <foreach collection="list" item="it" separator=",">
	      (
	        #{it.waveHeight},
	        #{it.seaSurfaceTemperature},
	        #{it.forecastTime},
	        ST_SetSRID(ST_MakePoint(#{it.lon}, #{it.lat}), 4326)
	      )
	    </foreach>
    	ON CONFLICT ((ST_Y(observed_location::geometry)), (ST_X(observed_location::geometry)), forecast_time)
	    DO UPDATE SET
	    <!-- 방금 insert하려는데 값이 이미 있으면 넣으려던 값으로 update -->
	      wave_height       = EXCLUDED.wave_height,
	      sea_surface_temperature = EXCLUDED.sea_surface_temperature,
	      observed_location = EXCLUDED.observed_location
    </insert>
    
    <!-- ========== 기상예보 업데이트 ========== -->
    <insert id="upsertUVDB" parameterType="java.util.List">
    	insert into tb_uv_info (rain_probability, uv_index, uv_index_clear_sky, forecast_time, observed_location)
    	values 
	    <foreach collection="list" item="it" separator=",">
	      (
	        #{it.rainProbability},
	        #{it.uvIndex},
	        #{it.uvIndexClearSky},
	        #{it.forecastTime},
	        ST_SetSRID(ST_MakePoint(#{it.lon}, #{it.lat}), 4326)
	      )
	    </foreach>
    	ON CONFLICT ((ST_Y(observed_location::geometry)), (ST_X(observed_location::geometry)), forecast_time)
	    DO UPDATE SET
	    <!-- 방금 insert하려는데 값이 이미 있으면 넣으려던 값으로 update -->
	      rain_probability   = EXCLUDED.rain_probability,
	      uv_index           = EXCLUDED.uv_index,
	      uv_index_clear_sky   = EXCLUDED.uv_index_clear_sky,
	      observed_location = EXCLUDED.observed_location
    </insert>
</mapper>