<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="lx.iseau.feature.beach.BeachDAO">

   <select id="findBeacheList" parameterType="BeachListRequest" resultType="BeachVO">
    SELECT
        beach_number,
        beach_name,
        beach_image,
        beach_information,
        rating,
        approved_by_ministry,
        address,    
        ST_Y(LOCATION::geometry) AS latitude,         
        ST_X(LOCATION::geometry) AS longitude,
        mobile,
        open_date,
        close_date
        FROM
        tb_beach
    WHERE
        1=1
   
    <if test="region != null and region != ''">
        AND address LIKE CONCAT(#{region}, '%')
    </if>
    
    <choose>
        <when test="sort == 'rating_desc'">
            ORDER BY rating DESC, beach_name ASC
        </when>
        <when test="sort == 'name_asc'">
            ORDER BY beach_name ASC
        </when>
        <otherwise>
            ORDER BY beach_number ASC
        </otherwise>
    </choose>
</select>

	<select id="getBeachDetailInfo" parameterType="int" resultType="ResponseBeachDTO">
		select beach_number,
		        beach_name,
		        beach_image,
		        beach_information,
		        rating,
		        approved_by_ministry,
		        address,    
		        ST_Y(LOCATION::geometry) AS latitude,         
		        ST_X(LOCATION::geometry) AS longitude,
		        mobile,
		        open_date,
		        close_date
		from tb_beach
		where beach_number = #{beachNumber}
	</select>
	
	<select id="getBeachDetailDanger" parameterType="int" resultType="ResponseBeachDangerDTO">
		select temperature, ST_Y(observed_location::geometry) AS lat, ST_X(observed_location::geometry) AS lon
		from tb_weather_info
		where observed_location = (select location
									from tb_beach
									where beach_number = #{beachNumber})
	</select>
<select id="getBeachDetailWeather" parameterType="int" resultType="ResponseBeachWeatherDTO">
    WITH beach_location AS (
        SELECT location FROM tb_beach WHERE beach_number = #{beachNumber}
    )
    
    SELECT
        tb_weather_info.temperature,
        tb_weather_info.wind_speed,
        tb_weather_info.forecast_time,
         tb_weather_info.humidity,
          tb_weather_info.wind_speed
    FROM
        tb_weather_info, beach_location
    WHERE
      
        ST_DWithin(
            tb_weather_info.observed_location,
            beach_location.location,
            3000  -- (반경 1000미터)
        )
        -- 4. 현재 시간 이후의 예보만 가져옵니다.
        AND tb_weather_info.forecast_time >= NOW()
    ORDER BY
        -- 5. [수정!] 해변 위치와 가장 가까운 순서로 정렬합니다.
        ST_Distance(tb_weather_info.observed_location, beach_location.location), 
        tb_weather_info.forecast_time ASC
    LIMIT 24;
</select>
</mapper>
