<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="lx.iseau.feature.group.GroupsDAO">

    <insert id="insertGroup" parameterType="RequestGroupDTO" useGeneratedKeys="true" keyProperty="groupNumber">
        INSERT INTO tb_group (
            group_leader, group_name
        )
        VALUES (
            #{groupLeader}, #{groupName}
        )
    </insert>

    <insert id="insertGroupMember" parameterType="map">
        INSERT INTO tb_group_member (
            group_number, group_member_number, marker_color, group_accepted
        )
        VALUES (
            #{groupNumber}, #{userNumber}, #{markerColor}, 
            <choose>
                <when test="status == 'ACCEPTED'"> 'Y' </when>
                <when test="status == 'PENDING'"> 'N' </when> 
                <otherwise> 'N' </otherwise>
            </choose>
        )
    </insert>
    
    <select id="SelectdoubleCheckByGroupName" parameterType="RequestGroupDTO" resultType="Integer">
        SELECT COUNT(*) AS cnt
        FROM tb_group
        WHERE 
        	group_leader = #{groupLeader}
        	AND group_name = #{groupName}
    </select>
    
    <select id="findGroupsByUserNumber" parameterType="int" resultType="ResponseGroupListItemDTO">
        SELECT
            g.group_number AS id,
            g.group_name AS name,
            (SELECT COUNT(*) FROM tb_group_member gm_count
             WHERE gm_count.group_number = g.group_number
             AND gm_count.group_accepted = 'Y') AS memberCount
        FROM tb_group_member gm
        JOIN tb_group g ON gm.group_number = g.group_number
        WHERE
            gm.group_member_number = #{userNumber}
            AND gm.group_accepted = 'Y'
    </select>
    
<select id="findPendingInvitationsByMember" parameterType="int" resultType="map">
        SELECT     
            g.group_number AS Id,  /* í”„ë¡ íŠ¸ì—”ë“œì—ì„œ group_numberë¥¼ invitationIdë¡œ ì‚¬ìš© */
            g.group_name AS groupName,
            
            u.user_name AS inviterName,      /* ğŸ’¡ ì´ˆëŒ€ìì˜ ì´ë¦„ */
            u.mobile AS inviterPhone,        /* ğŸ’¡ ì´ˆëŒ€ìì˜ ì „í™”ë²ˆí˜¸ */
            
            -- PENDING ìƒíƒœì¸ ë©¤ë²„ ì •ë³´
            gm.group_member_number AS userNumber,
            gm.group_number AS groupNumber,
            -- ê·¸ë£¹ì˜ í˜„ì¬ ìŠ¹ì¸ëœ ë©¤ë²„ ìˆ˜ ê³„ì‚° (ì„ íƒ ì‚¬í•­ì´ì§€ë§Œ ëª©ë¡ ì¡°íšŒ DTOë¥¼ ëŒ€ì²´í•˜ê¸° ìœ„í•´ í¬í•¨)
            (SELECT COUNT(*) 
             FROM tb_group_member gm_count 
             WHERE gm_count.group_number = g.group_number
             AND gm_count.group_accepted = 'Y') AS memberCount
        FROM
            tb_group_member gm
        JOIN 
            tb_group g ON gm.group_number = g.group_number
        JOIN
            tb_user u ON g.group_leader = u.user_number  /* ğŸ’¡ ê·¸ë£¹ ë¦¬ë” (ì´ˆëŒ€ì) ì •ë³´ ì¡°ì¸ */
        WHERE
            gm.group_member_number = #{userNumber}
            AND gm.group_accepted = 'N'
    </select>
    
    <update id="updateInviteStatus" parameterType="map">
        <if test="status == 'ACCEPTED'">
            UPDATE tb_group_member
            SET group_accepted = 'Y'
            WHERE
                group_number = #{invitationId}
                AND group_member_number = #{userNumber}
                AND group_accepted = 'N'
        </if>
        <if test="status == 'REJECTED'">
            DELETE FROM tb_group_member
            WHERE
                group_number = #{invitationId}
                AND group_member_number = #{userNumber}
                AND group_accepted = 'N'
        </if>
    </update>

    <select id="findGroupMemberLocations" parameterType="ResponseGroupMemberLocationDTO" resultType="ResponseGroupMemberLocationDTO">
    SELECT
        u.user_number AS id,
        ST_Y(u.location::geometry) AS lat,
        ST_X(u.location::geometry) AS lng,
        u.user_name AS name,
        gm.marker_color AS color,
        
        -- ğŸ’¡ [ìˆ˜ì •] DB ìƒíƒœ ('Y'/'N')ë¥¼ í”„ë¡ íŠ¸ì—”ë“œ ìƒíƒœ ('online'/'pending')ë¡œ ë³€í™˜
        CASE gm.group_accepted
            WHEN 'Y' THEN 'online'
            WHEN 'N' THEN 'pending'
            ELSE 'offline'
        END AS status, 
        
        u.status AS userStatus,
        
        ST_DistanceSphere(
            u.location::geometry,
            ST_SetSRID(ST_MakePoint(#{myLongitude}, #{myLatitude}), 4326)
        ) AS distance
    
    FROM tb_group_member gm
    JOIN tb_user u ON gm.group_member_number = u.user_number WHERE
        gm.group_number = #{groupNumber}
        AND gm.group_accepted = 'Y'
</select>

    <select id="findGroupByGroupNumber" resultType="ResponseGroupDTO" parameterType="int">
        SELECT 
            group_number,
            group_leader,
            group_name
        FROM 
            tb_group
        WHERE 
            group_number = #{groupNumber}
        LIMIT 1
    </select>

    <select id="findGroupLeaderByGroupId" resultType="int" parameterType="int">
        SELECT 
            group_leader
        FROM 
            tb_group
        WHERE 
            group_number = #{groupId} LIMIT 1
    </select>
    
    <select id="findGroupIdByUser" parameterType="int" resultType="Integer">
        SELECT group_number
        FROM tb_group_member
        WHERE group_member_number = #{userNumber}
          AND group_accepted = 'Y'
    </select>
    
    <select id="findUserNumberById" parameterType="string" resultType="Integer">
        SELECT user_number
        FROM tb_user
        WHERE id = #{userId}
    </select>
    
    <delete id="deleteGroup" parameterType="map">
        DELETE FROM tb_group
        WHERE
            group_number = #{groupId}
            AND group_leader = #{leaderUserNumber}
    </delete>
    
    <delete id="deleteGroupMembersByGroupId" parameterType="int">
        DELETE FROM tb_group_member WHERE group_number = #{groupId}
    </delete>
    
    <delete id="deleteGroupSettingsByGroupId" parameterType="int">
        DELETE FROM tb_group_settings WHERE group_number = #{groupId}
    </delete>
    
    <delete id="leaveGroupAsMember" parameterType="map">
        DELETE FROM tb_group_member 
        WHERE
            group_number = #{groupNumber}
            AND group_member_number = #{userNumber}
    </delete>
<select id="getGroupSettings" parameterType="int" resultType="RequestGroupSettingsDTO">
    SELECT
        group_number AS groupNumber,
        tide_alert AS tideAlert,
        group_leave_level1_alert AS groupLeaveLevel1Alert,
        group_leave_level1_distance AS groupLeaveLevel1Distance,
        group_leave_level2_alert AS groupLeaveLevel2Alert,
        group_leave_level2_distance AS groupLeaveLevel2Distance,
        group_leave_level3_alert AS groupLeaveLevel3Alert,
        group_leave_level3_distance AS groupLeaveLevel3Distance
    FROM tb_group_settings
    WHERE group_number = #{groupNumber}
</select>

    <insert id="insertOrUpdateGroupSettings" parameterType="RequestGroupSettingsDTO">
        INSERT INTO tb_group_settings (
            group_number, tide_alert, group_leave_level1_alert, 
            group_leave_level1_distance, group_leave_level2_alert, 
            group_leave_level2_distance, group_leave_level3_alert, 
            group_leave_level3_distance
        )
        VALUES (
            #{groupNumber}, #{tideAlert}, #{groupLeaveLevel1Alert},
            #{groupLeaveLevel1Distance}, #{groupLeaveLevel2Alert},
            #{groupLeaveLevel2Distance}, #{groupLeaveLevel3Alert},
            #{groupLeaveLevel3Distance}
        )
        ON CONFLICT (group_number) DO UPDATE SET
            tide_alert = EXCLUDED.tide_alert,
            group_leave_level1_alert = EXCLUDED.group_leave_level1_alert,
            group_leave_level1_distance = EXCLUDED.group_leave_level1_distance,
            group_leave_level2_alert = EXCLUDED.group_leave_level2_alert,
            group_leave_level2_distance = EXCLUDED.group_leave_level2_distance,
            group_leave_level3_alert = EXCLUDED.group_leave_level3_alert,
            group_leave_level3_distance = EXCLUDED.group_leave_level3_distance
    </insert>
</mapper>