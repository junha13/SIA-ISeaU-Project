<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="lx.iseau.feature.group.GroupsDAO">

    <insert id="insertGroup" parameterType="RequestGroupDTO"> 
		INSERT INTO tb_group (
            group_leader, group_member, group_name, 
            group_accepted, marker_color
        )
		VALUES (
            #{userId}, #{userId}, #{groupName}, 
            'Y', 'blue'
        )
	</insert>
	
    <select id="SelectdoubleCheckByGroupName" parameterType="RequestGroupDTO" resultType="Integer">
        SELECT COUNT(*) AS cnt
        FROM tb_group
        WHERE 
        	group_leader = #{userId}
        	AND group_name = #{groupName}
    </select>
    
    <select id="findUserNumberById" parameterType="string" resultType="Integer">
        SELECT user_number
        FROM tb_user
        WHERE id = #{userId}
    </select>

    <select id="findGroupsByUserNumber" parameterType="int" resultType="ResponseGroupListItemDTO">
        SELECT
            g.group_number AS id,
            g.group_name AS name,
            (SELECT COUNT(*) 
             FROM tb_group gm 
             WHERE gm.group_leader = g.group_leader 
               AND gm.group_name = g.group_name
               AND gm.group_accepted = 'Y' -- ìˆ˜ë½í•œ ë©¤ë²„ë§Œ ì¹´ìš´íŠ¸
            ) AS memberCount
        FROM
            tb_group g
        WHERE
            g.group_member = #{userNumber} -- ë‚´ê°€ ë©¤ë²„ë¡œ ì†í•œ
            AND g.group_accepted = 'Y' -- ìˆ˜ë½ëœ ê·¸ë£¹ë§Œ
        GROUP BY 
            g.group_number, g.group_name, g.group_leader
        ORDER BY
            g.group_name
    </select>

    <insert id="insertInvitation" parameterType="RequestGroupInviteDTO">
        INSERT INTO tb_group (
            group_leader,   group_member,   group_name,     group_accepted, marker_color
        )
        SELECT
            g.group_leader,        -- í˜„ì¬ ê·¸ë£¹(groupId)ì˜ ë¦¬ë”
            #{targetUserNumber},   -- ì´ˆëŒ€ ëŒ€ìƒì (DTOì—ì„œ ë°›ìŒ)
            g.group_name,          -- í˜„ì¬ ê·¸ë£¹(groupId)ì˜ ì´ë¦„
            'N',                   -- ìƒíƒœ: 'N' (ì´ˆëŒ€ ëŒ€ê¸°)
            #{markerColor}         -- DTOì—ì„œ ë°›ìŒ
        FROM tb_group g
        WHERE g.group_number = #{groupId}
        LIMIT 1 </insert>

    <select id="findInvitationById" parameterType="int" resultType="InvitationDTO">
        SELECT     
            g.group_number        AS invitationId,    g.group_number        AS groupId,         
            g.group_leader        AS inviterUserNumber, g.group_member        AS targetUserNumber,  'PENDING'             AS status,          g.marker_color        AS markerColor,
            g.group_name          AS groupName
            -- u.user_name AS inviterName (í•„ìš”ì‹œ tb_user JOIN ì¶”ê°€)
        FROM
             tb_group g
        WHERE
            g.group_number = #{invitationId}
            AND g.group_accepted = 'N' -- 'N' (ì´ˆëŒ€ ëŒ€ê¸°) ìƒíƒœì¸ ê²ƒë§Œ
    </select>
    
    <update id="updateInviteStatus" parameterType="map">
        <if test="status == 'ACCEPTED'">
            UPDATE tb_group
            SET group_accepted = 'Y'
            WHERE
                group_number = #{invitationId}
                AND group_accepted = 'N'
        </if>
        <if test="status == 'REJECTED'">
            DELETE FROM tb_group
            WHERE
                group_number = #{invitationId}
                AND group_accepted = 'N'
        </if>
    </update>

    <insert id="insertGroupMember" parameterType="RequestGroupDTO">
        INSERT INTO tb_group (
            group_leader, group_member, group_name,
            group_accepted, marker_color
        ) VALUES (
            #{groupLeader}, #{groupMember}, #{groupName},
            'Y', #{markerColor}
        )
    </insert>

   <select id="findGroupMemberLocations" parameterType="int" resultType="ResponseGroupMemberLocationDTO">
        WITH CurrentGroup AS (
            -- 1. í˜„ì¬ groupId(PK)ë¡œ ì´ ê·¸ë£¹ì˜ ë…¼ë¦¬ì  í‚¤(group_leader, group_name)ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
            SELECT 
                group_leader, 
                group_name
            FROM 
                tb_group
            WHERE 
                group_number = #{groupId}
            LIMIT 1
        )
        -- 2. ìœ„ì—ì„œ ì°¾ì€ ë…¼ë¦¬ì  í‚¤(leader, name)ì™€ ì¼ì¹˜í•˜ëŠ” ëª¨ë“  ë©¤ë²„ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
        SELECT
            u.user_number AS id,
            ST_Y(u.location::geometry) AS lat,
            ST_X(u.location::geometry) AS lng,
            u.user_name AS name,
            g.marker_color AS color,
            
            -- ğŸš¨ [í•µì‹¬ ìˆ˜ì •] 
            -- group_accepted ê°’ì— ë”°ë¼ statusë¥¼ 'online' ë˜ëŠ” 'pending'ìœ¼ë¡œ ë¶„ê¸°í•©ë‹ˆë‹¤.
            CASE 
                WHEN g.group_accepted = 'Y' THEN 'online'
                WHEN g.group_accepted = 'N' THEN 'pending'
                ELSE 'unknown'
            END AS status,
            
            (NOW() AT TIME ZONE 'UTC')::TIMESTAMP AS lastUpdate
        FROM
            tb_group g
        JOIN 
            tb_user u ON g.group_member = u.user_number
        JOIN 
            CurrentGroup cg ON g.group_leader = cg.group_leader AND g.group_name = cg.group_name
        
        -- ğŸš¨ [í•µì‹¬ ìˆ˜ì •]
        -- 'Y'ì¸ ë©¤ë²„ë§Œ í•„í„°ë§í•˜ëŠ” WHERE ì ˆì„ ì‚­ì œí•´ì•¼ 'N'ì¸ ë©¤ë²„ë„ ë³´ì…ë‹ˆë‹¤.
        -- WHERE
        --    g.group_accepted = 'Y' 
            
    </select>

    <select id="findGroupLeaderByGroupId" resultType="int" parameterType="int">
    SELECT 
        group_leader
    FROM 
        tb_group
    WHERE 
        group_number = #{groupId} LIMIT 1
</select>
<select id="findPendingInvitationsByMember" parameterType="int" resultType="InvitationDTO">
    SELECT     
        g.group_number        AS invitationId,    
        g.group_number        AS groupId,         
        g.group_leader        AS inviterUserNumber, 
        g.group_member        AS targetUserNumber,  
        'PENDING'             AS status,          
        g.marker_color        AS markerColor,
        g.group_name          AS groupName,
        (SELECT u.user_name FROM tb_user u WHERE u.user_number = g.group_leader) AS inviterName
    FROM
         tb_group g
    WHERE
        g.group_member = #{userNumber} -- í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì
        AND g.group_accepted = 'N'     -- 'N' (ì´ˆëŒ€ ëŒ€ê¸°) ìƒíƒœì¸ ê²ƒë§Œ
</select>
<delete id="deleteGroupAsLeader" parameterType="int">
        DELETE FROM tb_group g1
        USING tb_group g2
        WHERE
            g2.group_number = #{groupId}
            AND g1.group_leader = g2.group_leader
            AND g1.group_name = g2.group_name
    </delete>

    <delete id="leaveGroupAsMember" parameterType="map">
        DELETE FROM tb_group
        WHERE
            group_number = #{groupId}
            AND group_member = #{userNumber}
            AND group_leader != #{userNumber}
    </delete>
</mapper>