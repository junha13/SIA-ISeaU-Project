<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="lx.iseau.feature.controltower.ControlTowerDAO">

    <insert id="insertWatchEvent">
        INSERT INTO tb_watch (
        user_number,
        heart_rate,
        occurred_at,
        watch_location,
        watch_altitude
        )
        VALUES (
        #{userNumber, jdbcType=INTEGER},
        #{heartRate, jdbcType=INTEGER},
        CAST(#{occurredAt} AS TIMESTAMP with time zone),
        CASE
        <!-- üö® ÏàòÏ†ï Î∂ÄÎ∂Ñ: ÌååÎùºÎØ∏ÌÑ∞ Îí§Ïóê ::numeric ÎòêÎäî ::double precisionÏùÑ Î∂ôÏó¨ ÌÉÄÏûÖÏùÑ Î™ÖÏãú -->
        WHEN #{watchLatitude}::double precision IS NOT NULL
        AND #{watchLongitude}::double precision IS NOT NULL
        THEN ST_SetSRID(
        ST_MakePoint(
        #{watchLongitude, jdbcType=DOUBLE},
        #{watchLatitude, jdbcType=DOUBLE}
        ),
        4326
        )::geography
        ELSE NULL
        END,
        #{watchAltitude, jdbcType=DOUBLE}
        )
    </insert>
    
    <!-- Ï∂îÌõÑÏóê ÏõåÏπò ÏµúÏã†Ïàú Ï°∞Ìöå
    <select id="selectLatestWatchByUser" parameterType="int" resultType="map">
	    SELECT
	        watch_nubmer,
	        user_number,
	        heart_rate,
	        occurred_at,
	        ST_Y(w.watch_location::geometry) AS latitude,
    		ST_X(w.watch_location::geometry) AS longitude
	    FROM tb_watch
	    WHERE user_number = #{userNumber}
	    ORDER BY occurred_at DESC
	</select>
 	-->
   

    <insert id="insertTaskOnEmergency">
        INSERT INTO tb_task (manager_number, user_number, task_processed)
        VALUES (#{managerNumber}, #{userNumber}, 0)
    </insert>
    
    <insert id="insertTaskOnManualReport">
    INSERT INTO tb_task (
        manager_number,
        user_number,
        task_processed,
        type,
        task_location,
        occurred_at
    )
    VALUES (
        #{managerNumber},
        #{userNumber},
        0,
        #{reportType, jdbcType=VARCHAR},  CASE
            WHEN #{latitude} IS NOT NULL AND #{longitude} IS NOT NULL
            THEN ST_SetSRID(
                    ST_MakePoint(
                        #{longitude, jdbcType=DOUBLE},
                        #{latitude, jdbcType=DOUBLE}
                    ),
                    4326
                 )::geography
            ELSE NULL
        END,
        NOW()
    )
</insert>

	
    <!-- =========================
         Îß§ÎãàÏ†Ä Í∏∞Î≥∏Ï†ïÎ≥¥ Ï°∞Ìöå
         ========================= -->
    <select id="selectManagerInfoByManagerNumber" resultType="ManagerInfoDTO">
        SELECT
            u.user_name AS managerName,
            u.mobile    AS mobile,
            u.email     AS email
        FROM tb_manager m
        JOIN tb_user u
          ON u.user_number = m.manager_number
        WHERE m.manager_number = #{managerNumber}
        LIMIT 1
    </select>

    <!-- =========================
         Îß§ÎãàÏ†Ä Í∏∞Î≥∏Ï†ïÎ≥¥ ÏàòÏ†ï
         ========================= -->
    <update id="updateManagerInfoByManagerNumber" parameterType="ManagerInfoDTO">
        UPDATE tb_user u
           SET user_name = COALESCE(#{managerName}, u.user_name),
               mobile    = COALESCE(#{mobile}, u.mobile),
               email     = COALESCE(#{email}, u.email)
          FROM tb_manager m
         WHERE u.user_number = m.manager_number
         	AND m.manager_number = #{managerNumber}
    </update>

    <!-- =========================
         Îß§ÎãàÏ†Ä Ï≤òÎ¶¨ Î¶¨Ïä§Ìä∏ (Í∞ÑÎã®)
         - tb_task + tb_watch + tb_user(ÌîºÏ≤ò) + tb_manager + tb_user(Îß§ÎãàÏ†Ä)
         ========================= -->
    <select id="getTaskListByManagerNumber"
	        resultType="TaskListDTO">
	  SELECT
	    t.task_number    AS taskNumber,
	    t.task_processed AS taskProcessed,
	    w.occurred_at    AS occurredAt,
	    u.birth_date     AS birthDate,
	    u.gender         AS gender
	  FROM tb_task t
	  JOIN tb_watch   w ON w.user_number   = t.user_number
	  JOIN tb_user    u ON u.user_number    = w.user_number
	  JOIN tb_manager m ON m.manager_number = t.manager_number
	  WHERE m.manager_number = #{managerNumber}
	  ORDER BY w.occurred_at DESC
	</select>
	  <!--  =========ÏàòÎèôÏã†Í≥† Ìò∏Ï∂úÎêúÍ±∞ ÏùΩÍ∏∞========= -->
	<select id="getTaskManualListByManagerNumber" resultType="TaskListDTO">
    SELECT
        t.task_number    AS taskNumber,
        t.task_processed AS taskProcessed,
        t.type           AS type,
        u.user_name      AS userName,  
        t.occurred_at    AS occurredAt,      
        
        u.birth_date     AS birthDate,       
        u.gender         AS gender,

        ST_X(t.task_location::geometry) AS userLon,
        ST_Y(t.task_location::geometry) AS userLat

    FROM tb_task t
    JOIN tb_user u ON u.user_number = t.user_number
    JOIN tb_manager m ON m.manager_number = t.manager_number
    
    WHERE m.manager_number = #{managerNumber}
      AND t.type IN ('MISSING', 'DROWNING', 'COLLAPSE', 'INJURY', 'MANUAL')
    
    ORDER BY t.occurred_at DESC
</select>

	

    <!-- =========================
         Ï≤òÎ¶¨ ÏÉÅÏÑ∏ (taskNumber)
         ========================= -->
         <select id="getTaskDetailByTaskNumber"
        parameterType="int"
        resultType="TaskDetailDTO">
    SELECT
        t.task_number AS taskNumber,
        t.task_processed AS taskProcessed,
        t.type AS type,
        
        -- üö® [ÏàòÏ†ï 1] ÏúÑÏπò ÌÜµÌï©: Task > Watch > User ÏàúÏúºÎ°ú 3Í∞ÄÏßÄ ÏúÑÏπòÎ•º COALESCE
        COALESCE(
            ST_X(t.task_location::geometry), 
            ST_X(w_latest.watch_location::geometry), 
            ST_X(u.location::geometry)
        ) AS userLon,
        COALESCE(
            ST_Y(t.task_location::geometry), 
            ST_Y(w_latest.watch_location::geometry), 
            ST_Y(u.location::geometry)
        ) AS userLat,
        
        u.birth_date AS birthDate,
        u.gender AS gender,
        
        -- üö® [ÏàòÏ†ï 2] ÏãúÍ∞Ñ ÌÜµÌï©: Task Î∞úÏÉù ÏãúÍ∞ÅÏùÑ ÏµúÏö∞ÏÑ†ÏúºÎ°ú ÏÇ¨Ïö©
        COALESCE(t.occurred_at, w_latest.occurred_at) AS occurredAt,
        
        w_latest.heart_rate AS heartRate
        
    FROM tb_task t
    JOIN tb_user  u ON u.user_number  = t.user_number
    
    -- Watch Îç∞Ïù¥ÌÑ∞ (BPM/ÏúÑÏπò)Î•º ÏµúÏã† 1Í±¥Îßå Í∞ÄÏ†∏Ïò§Îäî LEFT JOIN
    LEFT JOIN (
        SELECT user_number, occurred_at, heart_rate, watch_location
        FROM tb_watch w_sub
        WHERE w_sub.occurred_at = (SELECT MAX(occurred_at) FROM tb_watch WHERE user_number = w_sub.user_number)
    ) w_latest ON w_latest.user_number = t.user_number 
    
    WHERE t.task_number = #{taskNumber}
    LIMIT 1
</select>

  <!-- =========================(ÏßÄÏÑú)
         Î°úÍ∑∏ Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå (userNumber)
         - tb_watch
         ========================= -->
    <select id="getTaskLogByUserNumber"
          resultType="TaskLogDTO"
          parameterType="int">

      SELECT DISTINCT
          w.occurred_at AS forTime,
          w.heart_rate  AS hr
      FROM tb_task t
      JOIN tb_watch w
        ON w.user_number = t.user_number
      WHERE t.user_number = #{userNumber}
      ORDER BY w.occurred_at DESC;

   </select>


  <!-- =========================(ÏßÄÏÑú)
         Í¥ÄÏ†úÏÑºÌÑ∞ Ï≤òÎ¶¨ Î¶¨Ïä§Ìä∏ (Ìï©ÏπòÍ∏∞)
         - tb_task + tb_watch + tb_user(ÌîºÏ≤ò) + tb_manager + tb_user(Îß§ÎãàÏ†Ä) + tb_control_tower
         ========================= -->
   <select id="getTaskListByControlTowerNumber"
        resultType="ControlTowerTaskListDTO"
        parameterType="int">

    SELECT *
    FROM (
      SELECT
        t.task_number    AS id,
        t.user_number    AS userNumber,
        t.task_processed AS taskProcessed,
        -- ÏõåÏπò ÏãúÍ∞ÑÏù¥ ÏóÜÏúºÎ©¥ Task Î∞úÏÉù ÏãúÍ∞ÑÏúºÎ°ú ÎåÄÏ≤¥
        COALESCE(w.occurred_at, t.occurred_at) AS dateAndTime, 
        u.birth_date     AS birthDateForAge,
        u.gender         AS gender,
        t.type           AS type,
        
        -- user ÏúÑÏπò
        ST_X(u.location::geometry)        AS userLon,
        ST_Y(u.location::geometry)        AS userLat,
        
        -- watch ÏúÑÏπò (ÏóÜÏùÑ Ïàò ÏûàÏùå)
        ST_X(w.watch_location::geometry)  AS watchLon,
        ST_Y(w.watch_location::geometry)  AS watchLat,
        
        -- ÏàòÎèô Ïã†Í≥† ÏúÑÏπò (Task Location) Ï∂îÍ∞Ä ÌïÑÏöîÌï® (ÏßÄÎèÑ ÌëúÏãúÏö©)
        ST_X(t.task_location::geometry)   AS taskLon,
        ST_Y(t.task_location::geometry)   AS taskLat,

        w.heart_rate     AS hr,
        w.watch_count    AS count,
        m.manager_number AS managerNumber,
        b.beach_name     AS beachName,
        ROW_NUMBER() OVER (
          PARTITION BY t.user_number
          ORDER BY COALESCE(w.occurred_at, t.occurred_at) DESC
        ) AS rn
      FROM tb_task t
      JOIN tb_manager m ON m.manager_number = t.manager_number
      JOIN tb_control_tower c ON c.control_tower_number = m.control_tower_number
      JOIN tb_user u ON u.user_number = t.user_number
      LEFT JOIN tb_beach b ON b.beach_number = u.beach_number
      
      -- üö® [ÌïµÏã¨ ÏàòÏ†ï] JOIN -> LEFT JOIN ÏúºÎ°ú Î≥ÄÍ≤Ω 
      -- (ÏõåÏπò Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏñ¥ÎèÑ ÏàòÎèô Ïã†Í≥†Îäî Î≥¥Ïó¨Ïïº Ìï®)
      LEFT JOIN (
        SELECT user_number,
               occurred_at,
               heart_rate,
               watch_location,
               COUNT(*) OVER (PARTITION BY user_number) AS watch_count
        FROM tb_watch
      ) w ON w.user_number = t.user_number
      
      WHERE c.control_tower_number = #{controlTowerNumber}
    ) sub
    WHERE sub.rn = 1
    ORDER BY sub.dateAndTime DESC;

</select>
    <!-- =========================
         Ï≤òÎ¶¨ÏôÑÎ£å ÌîåÎûòÍ∑∏ ÏàòÏ†ï
         ========================= -->
    <update id="updateTaskProcessed">
        UPDATE tb_task
           SET task_processed = #{taskProcessed}
         WHERE task_number    = #{taskNumber}
    </update>

</mapper>
