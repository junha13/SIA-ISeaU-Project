<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="lx.iseau.feature.post.PostDAO">

    <resultMap id="postMap" type="ResponsePostDTO">
        <id     column="post_number"        property="postNumber"/>
        <result column="post_title"         property="postTitle"/>
        <result column="post_content"       property="postContent"/>
        <result column="created_at"         property="createdAt"  jdbcType="TIMESTAMP"/>
        <result column="user_number"        property="userNumber"/>
        <result column="view_count"         property="viewCount"/>

        <result column="board_name"         property="boardName"/>
        <result column="id"                 property="id"/>

        <result column="recommend_count"    property="recommendCount"/>
        <result property="recommendedByMe"  column="recommended_by_me" jdbcType="BOOLEAN"/>

        <result property="commentContent"  column="comment_content"/>
    </resultMap>
    <!-- ========== 게시글 목록 조회 ========== -->
    <select id="selectPostList" resultMap="postMap">
        SELECT
            p.post_number,
            p.post_title,
            p.created_at,
            p.user_number,
            p.view_count,
            b.board_name,
            u.id,
            COALESCE(r.cnt, 0) AS recommend_count
        FROM tb_post p
        	JOIN tb_board b
        		ON p.board_number = b.board_number
        	join tb_user u
        		on p.user_number = u.user_number
    		LEFT JOIN (
					SELECT post_number, COUNT(*) AS cnt
					FROM tb_post_recommend
					GROUP BY post_number
					) r
				ON r.post_number = p.post_number
        ORDER BY created_at DESC
    </select>

    <!-- ========== 게시글 상세 조회 ========== -->
    <select id="selectPostDetailByPostId" parameterType="int" resultMap="postMap">
        SELECT
            p.post_number,
            p.post_title,
            p.post_content,
            p.created_at,
            p.user_number,
            p.board_number,
            p.view_count,
            b.board_name,
            u.id,
            COALESCE(r.cnt, 0) AS recommend_count
			FROM tb_post p
                 JOIN tb_board b ON p.board_number = b.board_number
                 JOIN tb_user u ON p.user_number = u.user_number
                 LEFT JOIN (
            SELECT post_number, COUNT(*) AS cnt
            FROM tb_post_recommend
            GROUP BY post_number
        ) r ON r.post_number = p.post_number
        WHERE p.post_number = #{postNumber}
    </select>

    <!-- ========== 게시글 추가 ========== -->
    <insert id="insertPostDB" parameterType="PostVO" useGeneratedKeys="true" keyProperty="postNumber">
        INSERT INTO tb_post (post_title, post_content, board_number, user_number, created_at, view_count, like_count)
        VALUES (#{postTitle}, #{postContent}, #{boardNumber}, #{userNumber}, now(), 0, 0)
    </insert>

    <!-- ========== board number select ( 게시글 insert 하려면 필요함 ) ========== -->
    <select id="selectBoardNumber" parameterType="BoardVO" resultType="int">
        SELECT board_number
        FROM tb_board
        WHERE board_name = #{boardName}
        LIMIT 1
    </select>

	<!-- ========== post detail 들어갈때마다 조회수 1 증가 ========== -->
    <update id="updateIncrementViewCount" parameterType="int">
        UPDATE tb_post
        SET view_count = view_count + 1
        WHERE post_number = #{postNumber}
    </update>

	<!-- ========== 추천 누를 수 있으면 추천 업 ========== -->
    <insert id="insertPostRecommend" parameterType="RequestPostRecommendDTO">
        insert into tb_post_recommend (post_number, user_number)
        VALUES (#{postNumber}, #{userNumber})
    </insert>

	<!-- ========== 추천 취소 ========== -->
    <delete id="deletePostRecommend" parameterType="RequestPostRecommendDTO">
		DELETE FROM tb_post_recommend
		WHERE 1=1
		AND post_number = #{postNumber}
		AND user_number = #{userNumber}
    </delete>

    <!-- ========== 뷰어가 해당 게시글에 추천을 햇는지 안했는지 검사 ========== -->
    <select id="selectPostRecommendByMe" parameterType="RequestPostRecommendDTO" resultType="boolean">
    /* 추천 안했으면 false , 했으면 true */
	  SELECT EXISTS (
	    SELECT 1
	    FROM tb_post_recommend
	    WHERE post_number = #{postNumber}
	      AND user_number = #{userNumber}
	  ) AS recommended_by_me
    </select>

	<!-- ========== 총 추천수 뽑기 ========== -->
    <select id="selectRecommendCount" parameterType="RequestPostRecommendDTO" resultType="int">
		SELECT COUNT(*)
		FROM tb_post_recommend
		WHERE post_number = #{postNumber}
    </select>

    <!-- ========== 게시글에 댓글 쓰는거임 ========== -->
    <insert id="insertPostCommentDB" parameterType="RequestPostCommentDTO">
        insert into tb_post_comment (comment_content, created_at, user_number, post_number)
        VALUES (#{commentContent}, now(), #{userNumber}, #{postNumber})
    </insert>

    <!-- ========== 댓글 리스트 뽑기 ========== -->
    <select id="selectCommentList" parameterType="int" resultType="RequestPostCommentDTO">
		select c.comment_content, c.created_at, c.user_number, c.post_number, u.id
		FROM tb_post_comment c join tb_user u
			on c.user_number = u.user_number
		WHERE post_number = #{postNumber}
    </select>

</mapper>
